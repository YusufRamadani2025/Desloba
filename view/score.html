<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DesLoba Scoreboard</title>
    <link rel="icon" type="image/x-icon" href="../assets/images/DesLoba-Logo.png">
    <link rel="stylesheet" href="./css/score.css">
</head>
<body>
    
    <div class="overlay" id="overlay"></div>
    
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <button class="close-btn" id="closeSidebar">&times;</button>
        </div>
        <div class="sidebar-menu">
            <a href="../index.html">Home</a>
            <a href="sound.html">Sound</a>
            <a href="score.html">Score</a>
            <a href="contact.html">Contact</a>
        </div>
    </aside>
    
    <nav class="navbar">
        <div class="navbar-logo">
            <img src="../assets/images/DesLoba-Logo.png" alt="Logo">
            <h1>DesLoba</h1>
        </div>
        <div class="navbar-menu">
            <a href="../index.html">Home</a>
            <a href="sound.html">Sound</a>
            <a href="score.html" style="color: var(--dasar);">Score</a>
            <a href="contact.html">Contact</a>
        </div>
        <div class="hamburger" id="hamburger">
            <span></span>
            <span></span>
            <span></span>
        </div>
    </nav>
    <main class="main-score">
        <div class="page-header">
            <h1>DIGITAL SCOREBOARD</h1>
            <p>Professional Timing & Scoring System</p>
        </div>
        
        <section id="setupSection" class="setup-card">
            <h2>Match Setup</h2>
            <div class="input-group">
                <label>HOST TEAM</label>
                <input type="text" id="inputTeam1" placeholder="Ex: Lakers" value="HOME">
            </div>
            <div class="input-group">
                <label>GUEST TEAM</label>
                <input type="text" id="inputTeam2" placeholder="Ex: Bulls" value="GUEST">
            </div>
            <div class="input-group">
                <label>GAME DURATION (Minutes)</label>
                <input type="number" id="inputTime" value="10" min="1" max="60">
            </div>
            <button id="btnStartGame" class="btn-primary">START MATCH</button>
        </section>
        
        <section id="scoreboardSection" class="scoreboard-container">
            
            <div class="timer-wrapper">
                <div class="period-badge" id="periodBadge">PERIOD 1</div>
                <div id="timer-display">10:00</div>
                
                <div class="timer-controls">
                    <button class="btn-control" id="btnAddMin">+1 Min</button>
                    <button class="btn-control" id="btnSubMin">-1 Min</button>
                    <button class="btn-control btn-start" id="btnTimerToggle">START</button>
                    <button class="btn-control" id="btnResetTimer">RESET TIME</button>
                    <button class="btn-control" id="btnNewGame" style="margin-left: 20px; border: 1px solid #555;">NEW GAME</button>
                </div>
            </div>
            
            <div class="match-grid">
                
                <div class="team-card" id="cardTeam1">
                    <h2 class="team-name" id="nameTeam1">HOME</h2>
                    <div class="score-display" id="scoreTeam1">0</div>
                    
                    <div class="score-actions">
                        <button class="btn-score" data-team="1" data-val="1">+1</button>
                        <button class="btn-score" data-team="1" data-val="2">+2</button>
                        <button class="btn-score" data-team="1" data-val="3">+3</button>
                        <button class="btn-score btn-minus" data-team="1" data-val="-1">-1</button>
                    </div>
                    
                    <div class="fouls-wrapper">
                        <span style="color:#aaa; font-weight:bold;">FOULS</span>
                        <div style="display:flex; align-items:center; gap:10px;">
                            <button class="btn-foul" onclick="updateFoul(1, -1)">-</button>
                            <span class="foul-count" id="foulTeam1">0</span>
                            <button class="btn-foul" style="background: var(--danger); color:white;" onclick="updateFoul(1, 1)">+</button>
                        </div>
                    </div>
                </div>
                
                <div style="text-align: center; align-self: center; font-size: 2rem; font-weight: bold; color: #333;">
                    VS
                </div>
                
                <div class="team-card" id="cardTeam2">
                    <h2 class="team-name" id="nameTeam2">GUEST</h2>
                    <div class="score-display" id="scoreTeam2">0</div>
                    
                    <div class="score-actions">
                        <button class="btn-score" data-team="2" data-val="1">+1</button>
                        <button class="btn-score" data-team="2" data-val="2">+2</button>
                        <button class="btn-score" data-team="2" data-val="3">+3</button>
                        <button class="btn-score btn-minus" data-team="2" data-val="-1">-1</button>
                    </div>
                    
                    <div class="fouls-wrapper">
                        <span style="color:#aaa; font-weight:bold;">FOULS</span>
                        <div style="display:flex; align-items:center; gap:10px;">
                            <button class="btn-foul" onclick="updateFoul(2, -1)">-</button>
                            <span class="foul-count" id="foulTeam2">0</span>
                            <button class="btn-foul" style="background: var(--danger); color:white;" onclick="updateFoul(2, 1)">+</button>
                        </div>
                    </div>
                </div>
                
            </div>
        </section>
    </main>

    <div class="custom-modal-overlay" id="customConfirm">
        <div class="confirm-box">
            <h3>RESET GAME?</h3>
            <p>Yakin mau mulai baru? Semua skor & waktu akan dihapus permanen.</p>
            <div class="confirm-actions">
                <button class="btn-confirm btn-no" id="cancelReset">BATAL</button>
                <button class="btn-confirm btn-yes" id="confirmReset">YAKIN!</button>
            </div>
        </div>
    </div>
    
    <script>
        // Sidebar Logic (Mobile)
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('overlay');
        const hamburger = document.getElementById('hamburger');
        const closeBtn = document.getElementById('closeSidebar');
        
        // Toggle Sidebar
        hamburger.addEventListener('click', () => {
            sidebar.classList.add('active');
            overlay.classList.add('active');
        });
        
        [closeBtn, overlay].forEach(el => {
            el.addEventListener('click', () => {
                sidebar.classList.remove('active');
                overlay.classList.remove('active');
            });
        });
        
        // ============================================
        // LOGIKA SCOREBOARD (Revised & Fixed)
        // ============================================
        
        // 1. State Management (Penyimpanan Data Sementara)
        const state = {
            team1: { name: 'HOME', score: 0, fouls: 0 },
            team2: { name: 'GUEST', score: 0, fouls: 0 },
            period: 1,
            timer: {
                totalSeconds: 600, // Default 10 menit
                remainingSeconds: 600,
                isRunning: false,
                intervalId: null,
                lastTime: null
            }
        };
        
        // Elements
        const setupSec = document.getElementById('setupSection');
        const boardSec = document.getElementById('scoreboardSection');
        const timerDisplay = document.getElementById('timer-display');
        const btnToggle = document.getElementById('btnTimerToggle');
        
        // 2. Load Data Saat Halaman Dibuka
        document.addEventListener('DOMContentLoaded', () => {
            const saved = localStorage.getItem('desloba_game');
            if (saved) {
                try {
                    const loaded = JSON.parse(saved);
                    // Update state dengan data yang disimpan
                    Object.assign(state, loaded);
                    
                    // Pastikan timer mati saat di-load (biar gak jalan sendiri)
                    state.timer.isRunning = false;
                    state.timer.lastTime = null;
                    
                    renderAll(); // Tampilkan data
                    toggleSection(true); // Langsung ke Scoreboard
                } catch (e) {
                    console.error("Data corrupt, resetting...", e);
                    localStorage.removeItem('desloba_game');
                }
            }
        });
        
        // 3. Fungsi Start Game (Dari Menu Setup)
        function startGame() {
            const t1 = document.getElementById('inputTeam1').value.trim() || 'HOME';
            const t2 = document.getElementById('inputTeam2').value.trim() || 'GUEST';
            const mins = parseInt(document.getElementById('inputTime').value) || 10;
            
            // Set Data Baru
            state.team1.name = t1;
            state.team2.name = t2;
            state.team1.score = 0; state.team1.fouls = 0;
            state.team2.score = 0; state.team2.fouls = 0;
            state.period = 1;
            
            // Reset Timer
            state.timer.totalSeconds = mins * 60;
            state.timer.remainingSeconds = state.timer.totalSeconds;
            state.timer.isRunning = false;
            
            saveState(); // Simpan data awal
            renderAll(); // Tampilkan di layar
            toggleSection(true); // Pindah halaman
        }
        
        // 4. Fungsi New Game (RESET TOTAL)
        const modal = document.getElementById('customConfirm');
        const btnYes = document.getElementById('confirmReset');
        const btnNo = document.getElementById('cancelReset');

        // A. Pas tombol "New Game" diklik -> Munculin Modal
        document.getElementById('btnNewGame').addEventListener('click', () => {
            modal.classList.add('active'); // Munculin pop-up
        });

        // B. Pas tombol "BATAL" diklik -> Tutup Modal
        btnNo.addEventListener('click', () => {
            modal.classList.remove('active');
        });

        // C. Pas tombol "YAKIN!" diklik -> Baru Jalankan Reset
        btnYes.addEventListener('click', () => {
            // 1. Tutup Modal dulu
            modal.classList.remove('active');

            // 2. Jalankan Logika Reset (Sama kayak sebelumnya)
            stopTimer();

            // Hapus Data Permanen
            localStorage.removeItem('desloba_game');

            // Reset Variabel State
            state.team1 = { name: 'HOME', score: 0, fouls: 0 };
            state.team2 = { name: 'GUEST', score: 0, fouls: 0 };
            state.period = 1;
            state.timer.totalSeconds = 600;
            state.timer.remainingSeconds = 600;
            state.timer.isRunning = false;

            // Kosongkan Form Input
            document.getElementById('inputTeam1').value = '';
            document.getElementById('inputTeam2').value = '';
            document.getElementById('inputTime').value = '10';

            // Kembalikan Tampilan ke Default
            renderAll();
            
            // Pindah ke Halaman Setup
            toggleSection(false);
        });

        // (Opsional) Tutup modal kalau klik area gelap di luar kotak
        modal.addEventListener('click', (e) => {
            if(e.target === modal) {
                modal.classList.remove('active');
            }
        });
        
        // Helper: Pindah Halaman (Setup <-> Scoreboard)
        function toggleSection(showBoard) {
            if (showBoard) {
                setupSec.style.display = 'none';
                boardSec.style.display = 'block'; // Atau 'grid' kalau landscape (diatur CSS)
            } else {
                setupSec.style.display = 'block';
                boardSec.style.display = 'none';
                boardSec.style.removeProperty('display'); // Biar CSS media query ambil alih
            }
        }
        
        // 5. Logika Timer (Akurat)
        function formatTime(sec) {
            const m = Math.floor(sec / 60).toString().padStart(2, '0');
            const s = (sec % 60).toString().padStart(2, '0');
            return `${m}:${s}`;
        }
        
        function startTimer() {
            if (state.timer.isRunning) return;
            
            state.timer.isRunning = true;
            state.timer.lastTime = Date.now();
            
            // Ubah tombol jadi PAUSE
            btnToggle.textContent = "PAUSE";
            btnToggle.classList.replace('btn-start', 'btn-pause');
            
            state.timer.intervalId = setInterval(() => {
                const now = Date.now();
                const delta = Math.floor((now - state.timer.lastTime) / 1000);
                
                if (delta >= 1) {
                    state.timer.remainingSeconds -= delta;
                    state.timer.lastTime = now; // update waktu terakhir
                    
                    if (state.timer.remainingSeconds <= 0) {
                        state.timer.remainingSeconds = 0;
                        stopTimer();
                        playAlarm(); // Bunyi
                        alert("Waktu Habis!");
                    }
                    
                    updateTimerDisplay();
                    saveState();
                }
            }, 100); // Cek setiap 100ms
        }
        
        function stopTimer() {
            state.timer.isRunning = false;
            clearInterval(state.timer.intervalId);
            
            // Ubah tombol jadi START
            btnToggle.textContent = "START";
            btnToggle.classList.replace('btn-pause', 'btn-start');
            saveState();
        }
        
        function updateTimerDisplay() {
            timerDisplay.textContent = formatTime(state.timer.remainingSeconds);
            // Warna merah kalau < 10 detik
            timerDisplay.style.color = state.timer.remainingSeconds <= 10 ? 'red' : 'var(--dasar)';
        }
        
        // 6. Logika Tombol Skor (Event Delegation)
        document.querySelectorAll('.btn-score').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const team = e.target.dataset.team;
                const val = parseInt(e.target.dataset.val);
                
                if (team == '1') state.team1.score += val;
                else state.team2.score += val;
                
                // Cegah minus
                if (state.team1.score < 0) state.team1.score = 0;
                if (state.team2.score < 0) state.team2.score = 0;
                
                renderScores();
                saveState();
            });
        });
        
        // Logika Foul (Global Function)
        window.updateFoul = function(team, val) {
            if (team === 1) state.team1.fouls += val;
            else state.team2.fouls += val;
            
            if (state.team1.fouls < 0) state.team1.fouls = 0;
            if (state.team2.fouls < 0) state.team2.fouls = 0;
            
            renderScores();
            saveState();
        };
        
        // 7. Render & Save Helper
        function renderAll() {
            document.getElementById('nameTeam1').textContent = state.team1.name;
            document.getElementById('nameTeam2').textContent = state.team2.name;
            document.getElementById('periodBadge').textContent = "PERIOD " + state.period;
            renderScores();
            updateTimerDisplay();
        }
        
        function renderScores() {
            document.getElementById('scoreTeam1').textContent = state.team1.score;
            document.getElementById('scoreTeam2').textContent = state.team2.score;
            document.getElementById('foulTeam1').textContent = state.team1.fouls;
            document.getElementById('foulTeam2').textContent = state.team2.fouls;
        }
        
        function saveState() {
            // Hapus intervalId dari data yang disimpan biar bersih
            const cleanState = { ...state };
            cleanState.timer = { ...state.timer, intervalId: null };
            localStorage.setItem('desloba_game', JSON.stringify(cleanState));
        }
        
        function playAlarm() {
            try {
                const ctx = new (window.AudioContext || window.webkitAudioContext)();
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.connect(gain);
                gain.connect(ctx.destination);
                osc.type = 'square';
                osc.frequency.value = 440; // Nada A
                gain.gain.exponentialRampToValueAtTime(0.00001, ctx.currentTime + 1);
                osc.start();
                osc.stop(ctx.currentTime + 1);
            } catch (e) {
                console.warn("Audio tidak didukung di browser ini");
            }
        }
        
        // 8. Event Listeners Tambahan
        document.getElementById('btnStartGame').addEventListener('click', startGame);
        
        document.getElementById('btnTimerToggle').addEventListener('click', () => {
            if (state.timer.isRunning) stopTimer();
            else startTimer();
        });
        
        document.getElementById('btnResetTimer').addEventListener('click', () => {
            stopTimer();
            state.timer.remainingSeconds = state.timer.totalSeconds;
            updateTimerDisplay();
            saveState();
        });
        
        document.getElementById('btnAddMin').addEventListener('click', () => {
            state.timer.remainingSeconds += 60;
            updateTimerDisplay();
            saveState();
        });
        
        document.getElementById('btnSubMin').addEventListener('click', () => {
            if (state.timer.remainingSeconds > 60) {
                state.timer.remainingSeconds -= 60;
                updateTimerDisplay();
                saveState();
            }
        });
        
        // Period Clicker
        document.getElementById('periodBadge').addEventListener('click', () => {
            state.period++;
            if (state.period > 4) state.period = 1;
            renderAll();
            saveState();
        });
    </script>
</body>
</html>